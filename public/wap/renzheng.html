<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<title>实名认证</title>
		<link rel="stylesheet" href="icons/iconfont.css" />
		<style type="text/css">
			* {
				padding: 0;
				margin: 0;
				box-sizing: border-box;
			}
			
			html,
			body {
				width: 100%;
				height: 100%;
				background: #f9f9f9;
			}
			
			a {
				text-decoration: none;
				outline: none;
				-webkit-tap-highlight-color: rgba(0, 0, 0, 0);
			}

			
			.rztishi,
			.cardtishi {
				width: 100%;
				height: 1.4rem;
				padding-left: 0.4rem;
				line-height: 1.4rem;
				background: #f9f9f9;
				color: #a4a4a4;
				font-size: 0.37rem;
			}
			
			.rzinputs {
				width: 100%;
				background: #fff;
			}
			
			.rzinputs div {
				width: 100%;
				height: 1.4rem;
			}
			
			.rzname input {
				width: 90%;
				margin: 0 5%;
				border: 0;
				border-bottom: 1px solid #D8D8D8;
				height: 100%;
				outline: none;
			}
			
			.rzidnum input {
				width: 90%;
				margin: 0 5%;
				border: 0;
				height: 100%;
				outline: none;
			}
			
			.buttondiv {
				width: 100%;
				margin: 0 auto;
				text-align: center;
			}
			
			.rzbutton {
				width: 80%;
				height: 1.4rem;
				background: #ffdd00;
				border-radius: 0.31rem;
				border: 0;
				margin-top: 1rem;
				font-size: 0.4rem;
				outline: none;
			}
			
			.cardpic {
				width: 100%;
				height: 3rem;
				position: relative;
			}
			
			.sfzpic {
				margin: 0 auto;
				width: 2.37rem;
				height: 2.37rem;
				position: relative;
			}
			
			.sfzpic img {
				width: 2.37rem;
				height: 2.37rem;
				position: absolute;
				top: 50%;
				margin-top: -1.19rem;
			}
			
			.sfzpic form {
				width: 2.37rem;
				position: absolute;
				top: 0;
				height: 2.37rem;
				opacity: 0;
				filter: alpha(opacity=0);
			}
			
			.sfzpic form input {
				width: 100%;
				height: 100%;
			}
		</style>
		<script src="flexible.min.js" type="text/javascript" charset="utf-8"></script>
	</head>

	<body>
		<div class="renzhengcon">
			<div class="rztishi">请填写本人实名信息，如非本人实名将无法提现</div>
			<div class="rzinputs">
				<div class="rzname">
					<input type="text" placeholder="请输入真实姓名" value="" class="nameinput" />
				</div>
				<div class="rzidnum">
					<input type="text" name="" id="" value="" placeholder="请输入身份证号" class="idnuminput" />
				</div>
			</div>
			<div class="cardtishi">上传一张手持身份证照片</div>
			<div class="cardpic">
				<div class="sfzpic">
					<img src="img/sfzpic.png" alt="" id="show1" class="cover" />
					<form action="" enctype="multipart/form-data" class="formimg">
						<input type="file" id="file" img-id="show1" class="filepath" onchange="changepic(this)" accept="image/*">
					</form>
				</div>
			</div>
			<div class="buttondiv">
				<button class="rzbutton">开始认证</button>
			</div>
		</div>

		<script src="yuming.js" type="text/javascript" charset="utf-8"></script>
		<script src="js/jquery-3.2.1.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="alertMsg.js" type="text/javascript" charset="utf-8"></script>
		<script type="text/javascript">
			//			获取token device
			//			传值:window.location.href = 'RegOk.htm?email='+email+'&name='+username+''; 
			function GetRequest() {
				var url = location.search; //获取url中"?"符后的字串
				var theRequest = new Object();
				if(url.indexOf("?") != -1) {
					var str = url.substr(1);
					strs = str.split("&");
					for(var i = 0; i < strs.length; i++) {
						theRequest[strs[i].split("=")[0]] = unescape(strs[i].split("=")[1]);
					}
				}
				return theRequest;
			}

			var request = new Object();
			request = GetRequest();
			//token device
			var yztoken = request['token'];
			var yzdevice = request['device'];
			var yzid = request['uid'];
//			var yztoken = 'e6d60e2923f3bdfc997692f73d32e8e656ea806ca5846c828d0b7f86591a2b99';
//			var yzdevice = 'android';
//			var yzid = 8;
//			var yztoken = '3de74cfd5e58e66f5817e2e520d2b43d269aa52ae521011e19a6f32a4cb57ca7';
//			var yzdevice = 'iphone';

			$('.rzbutton').click(function() {
				rzname = $('.nameinput').val();
				rzidnum = $('.idnuminput').val();
				console.log(rzname);
				console.log(rzidnum);
				if(rzname == '') {
					alertMsg('请输入姓名');
					return false;
				} else if(rzidnum == '') {
					alertMsg('请输入身份证号');
					return false;
				} else if(!(/^[\u4E00-\u9FA5]{1,4}$/.test(rzname))) {
					alertMsg('姓名输入有误');
					return false;
				} else if(!(/(^\d{15}$)|(^\d{18}$)|(^\d{17}(\d|X|x)$)/.test(rzidnum))) {
					alertMsg('身份证号输入有误');
					return false;
				} else {
//					var rzurl = 'http://yz.baiyoumi.cn/api/user/profile/trueName';
					var rzurl = geturl(oneurl,'user/profile/trueName');
					$.ajax({
						headers: {
							'YZ-Token': yztoken,
							'YZ-Device-Type': yzdevice
						},
						type: "post",
						url: rzurl,
						dataType: "json",
						data: {
							"name": rzname,
							"idnum": rzidnum
						},
						success: function(result) {
							console.log(JSON.stringify(result));
							alertMsg(result.msg);
						},
						error: function(result) {
							console.log('实名认证失败');
						}
					});
				}
			})

			//将base64转换为文件
			function dataURLtoFile(dataurl, filename) {
				var arr = dataurl.split(','),
					mime = arr[0].match(/:(.*?);/)[1],
					bstr = atob(arr[1]),
					n = bstr.length,
					u8arr = new Uint8Array(n);
				while(n--) {
					u8arr[n] = bstr.charCodeAt(n);
				}
				return new File([u8arr], filename, {
					type: mime
				});
			};

			function changepic(aa) {
				if(typeof FileReader == "undefined") {
					alert("您的浏览器不支持FileReader对象！");
				}

				var fileimg = document.getElementById('file').files[0]; //获取file对象
				//判断file类型是否为图片
				if(!fileimg) {
					return
				}

				var imgtype = fileimg.type.substring(fileimg.type.lastIndexOf("/") + 1).toLowerCase();
				//				console.log(imgtype);
				if(imgtype != "jpg" && imgtype != 'jpeg' && imgtype != 'png') {
					console.log(imgtype);
					console.log('图片格式不对');
				}

				//设置限制图像的大小为2M
				var maximgsize = 1024 * 1024 * 2;
				if(fileimg.size > maximgsize) {
					//					alert('文件大小不超过2M');
					//					return
				}
				var reader = new FileReader(); //声明一个FileReader实例
				reader.readAsDataURL(fileimg); //调用redsAsDataURL方法读取选中的文件
				reader.onload = function(e) { //利用onload事件中获取到成功读取的选中的图像文件，并以插入一个img方式来显示读取的图像文件
					var img = new Image();
					img.src = e.target.result;
					img.onload = function() {
						var w = this.width,
							h = this.height,
							scale = w / h;
						if(w > 600) {
							w = 600;
						}
						h = w / scale;
						var canvas = document.createElement('canvas');
						var ctx = canvas.getContext('2d');
						$(canvas).attr({
							width: w,
							height: h
						});
						ctx.drawImage(this, 0, 0, w, h);
						var base64 = canvas.toDataURL('image/jpeg', 1 || 0.8);
						console.log(base64);
						var fd = new FormData();
						fd.append("act", "card");
						fd.append("file", dataURLtoFile(base64, "card.jpg")); //加入文件对象
						upcard(fd);
					}

				};
			}

			function upcard(fd) {
//				var headurl = 'http://yz.baiyoumi.cn/api/user/upload/img';
				var headurl = geturl(oneurl,'user/upload/img');
				$.ajax({
					headers: {
						'YZ-Token': yztoken,
						'YZ-Device-Type': yzdevice
					},
					url: headurl,
					type: 'POST',
					datatype: 'json',
					data: fd,
					cache: false,
					traditional: true,
					contentType: false,
					processData: false,
					success: function(result) {
						console.log(JSON.stringify(result));
						if(result.code == 1) {
							document.getElementById('show1').src = 'http://'+ yuming + result.data.url;
						}
					},
					error: function(data) {
						console.log(data.responseText);
					}
				})
			}
		</script>
	</body>

</html>